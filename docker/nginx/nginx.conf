user  nginx;
worker_processes auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    client_max_body_size 20M;

    # ------------------------
    # SSL CONFIG
    # ------------------------
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ------------------------
    # PHP upstream (PHP 8.5)
    # ------------------------
    upstream php {
        server php84:9000;
    }

    # ------------------------
    # HTTP -> HTTPS redirect
    # ------------------------
    server {
        listen 80;
        server_name back.local;
        return 301 https://$host$request_uri;
    }

    # ------------------------
    # HTTPS API server
    # ------------------------
    server {
        listen 443 ssl http2;
        server_name back.local;

        root /var/www/html/public;
        index index.php;

        ssl_certificate     /etc/nginx/ssl/back.local.pem;
        ssl_certificate_key /etc/nginx/ssl/back.local-key.pem;

        # Security headers (API safe)
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Laravel routing (API only)
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # PHP handling
        location ~ \.php$ {
            try_files $uri =404;
            include fastcgi_params;
            fastcgi_pass php;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            fastcgi_param DOCUMENT_ROOT $realpath_root;
        }

        # Deny hidden files
        location ~ /\. {
            deny all;
        }
    }
}
